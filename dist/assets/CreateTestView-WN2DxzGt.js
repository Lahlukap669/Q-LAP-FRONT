import{a as v,A as _}from"./api-BJgnF3hB.js";import{T as w}from"./TrainerHeader-DWaHe2Wg.js";import{_ as F,c as n,e as C,b as I,f as S,a as t,t as u,d as x,k as g,v as E,l as j,F as h,j as b,m as k,o as l,n as T}from"./index-CZfNrfaq.js";const z={name:"CreateTestView",components:{TrainerHeader:w},data(){return{loading:!0,error:null,testExercises:[],athletes:[],exerciseValues:{},showModal:!1,selectedExercise:{},testForm:{test_date:new Date().toISOString().split("T")[0],athlete_id:""},pastTestInfo:{found_past_test:!1,most_recent_test_id:null,most_recent_test_date:null,exercises:[]}}},computed:{userFullName(){const s=JSON.parse(localStorage.getItem("user")||"{}");return`${s.first_name} ${s.last_name}`||"Trainer"},isFormValid(){return!this.testForm.test_date||!this.testForm.athlete_id?!1:this.pastTestInfo.found_past_test?this.pastTestInfo.exercises.map(r=>r.exercise_id).every(r=>{const p=this.exerciseValues[r];return p&&p.value&&p.unit}):Object.values(this.exerciseValues).some(s=>s.value&&s.unit)}},methods:{async fetchAthletes(){try{const s=localStorage.getItem("access_token"),e=await v.get(`${_.LOGIN.replace("/auth/login","")}/users/trainer/my-athletes`,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});this.athletes=e.data.athletes||[]}catch(s){console.error("Napaka pri nalaganju športnikov:",s)}},async fetchTestExercises(){this.loading=!0,this.error=null;try{const s=localStorage.getItem("access_token"),e=await v.get(`${_.LOGIN.replace("/auth/login","")}/users/trainer/get-test-exercises`,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});this.testExercises=e.data.data||[],this.initializeExerciseValues()}catch(s){console.error("Error:",s),this.error="Napaka pri nalaganju vaj."}finally{this.loading=!1}},async fetchPastTestExercises(){if(!this.testForm.test_date||!this.testForm.athlete_id){this.pastTestInfo={found_past_test:!1,most_recent_test_id:null,most_recent_test_date:null,exercises:[]};return}try{const s=localStorage.getItem("access_token"),e=await v.post(`${_.LOGIN.replace("/auth/login","")}/users/trainer/get-past-test-exercises`,{test_date:this.testForm.test_date,athlete_id:parseInt(this.testForm.athlete_id)},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});this.pastTestInfo=e.data,this.pastTestInfo.found_past_test&&this.pastTestInfo.exercises&&this.pastTestInfo.exercises.forEach(r=>{this.exerciseValues[r.exercise_id]&&(this.exerciseValues[r.exercise_id].unit=r.unit)})}catch(s){console.error("Napaka pri pridobivanju preteklih vaj:",s),this.pastTestInfo={found_past_test:!1,most_recent_test_id:null,most_recent_test_date:null,exercises:[]}}},onFormChange(){this.fetchPastTestExercises()},isPastTestExercise(s){return this.pastTestInfo.exercises.some(e=>e.exercise_id===s)},formatDate(s){return s?new Date(s).toLocaleDateString("sl-SI",{year:"numeric",month:"long",day:"numeric"}):""},initializeExerciseValues(){const s={};this.testExercises.forEach(e=>{e.method_groups.forEach(r=>{r.exercises.forEach(p=>{s[p.id]={value:"",unit:""}})})}),this.exerciseValues=s},showExerciseInfo(s){this.selectedExercise=s,this.showModal=!0},closeModal(){this.showModal=!1},clearAllValues(){this.initializeExerciseValues()},async saveTestResults(){var r,p,o;if(!this.testForm.athlete_id||!this.testForm.test_date){alert("Športnik in datum sta obvezna");return}const s=Object.entries(this.exerciseValues).filter(([a,d])=>d.value&&d.unit).map(([a,d])=>({exercise_id:parseInt(a),measure:parseFloat(d.value),unit:d.unit}));if(s.length===0){alert("Vsaj ena vaja skupaj z meritvijo in enoto je obvezna.");return}if(this.pastTestInfo.found_past_test){const d=this.pastTestInfo.exercises.map(i=>i.exercise_id).filter(i=>{const m=this.exerciseValues[i];return!m||!m.value||!m.unit});if(d.length>0){alert(`Vse vaje iz prejšnjega testa morajo biti izpolnjene. Manjkajo ${d.length} vaje/a.`);return}}const e={athlete_id:parseInt(this.testForm.athlete_id),date:this.testForm.test_date,exercises:s};this.loading=!0;try{const a=localStorage.getItem("access_token");if(!a){this.$router.push("/login");return}console.log("Creating test with payload:",e);const d=await v.post(`${_.LOGIN.replace("/auth/login","")}/users/trainer/create-test`,e,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});alert(d.data.message||"Test created successfully"),this.clearAllValues(),this.testForm={test_date:new Date().toISOString().split("T")[0],athlete_id:""},setTimeout(()=>{this.$router.push("/trainer/tests")},1500)}catch(a){if(console.error("Error creating test:",a),((r=a.response)==null?void 0:r.status)===401)localStorage.removeItem("access_token"),localStorage.removeItem("user"),this.$router.push("/login");else{const d=((o=(p=a.response)==null?void 0:p.data)==null?void 0:o.message)||"Napaka pri ustvarjanju testa";alert(d)}}finally{this.loading=!1}},getMissingPastExercisesCount(){return this.pastTestInfo.found_past_test?this.pastTestInfo.exercises.map(e=>e.exercise_id).filter(e=>{const r=this.exerciseValues[e];return!r||!r.value||!r.unit}).length:0},getCompletedPastExercisesCount(){return this.pastTestInfo.found_past_test?this.pastTestInfo.exercises.map(e=>e.exercise_id).filter(e=>{const r=this.exerciseValues[e];return r&&r.value&&r.unit}).length:0},logout(){localStorage.removeItem("access_token"),localStorage.removeItem("user"),this.$router.push("/login")}},mounted(){this.fetchAthletes(),this.fetchTestExercises()}},N={class:"min-h-screen test-bg"},A={key:0,class:"flex items-center justify-center min-h-screen"},P={key:1,class:"flex items-center justify-center min-h-screen"},M={class:"text-center bg-white rounded-xl p-8 mx-4"},O={class:"text-gray-600 mb-4"},D={key:2,class:"container mx-auto px-4 py-6"},B={class:"test-header rounded-xl p-6 mb-6"},L={class:"flex items-center justify-between"},R={class:"flex items-center space-x-4"},U={class:"dropdown-container"},G={class:"dropdown-container"},H=["value"],J={key:0,class:"past-test-banner rounded-xl p-4 mb-6"},q={class:"flex items-center"},K={class:"text-orange-700 text-sm"},Q={class:"exercises-table rounded-xl overflow-hidden"},W={class:"exercise-rows"},X={class:"motor-ability-row"},Y={class:"motor-ability-title"},Z={class:"method-group-row"},$={class:"method-group-title"},ee={class:"col-span-6 flex items-center"},te={class:"flex items-center space-x-2"},se={key:0,class:"flex items-center space-x-1"},ae={class:"exercise-name"},ie={class:"col-span-3 flex justify-center"},oe=["onUpdate:modelValue"],re={class:"col-span-2 flex justify-center"},ne=["onUpdate:modelValue"],le={class:"col-span-1 flex justify-center"},de=["onClick"],ce={class:"flex space-x-4 justify-center mt-6"},ue=["disabled"],pe={key:3,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"},me={class:"modal-content max-w-2xl w-full"},xe={class:"flex justify-between items-start mb-4"},he={class:"modal-title"},fe={class:"description-text"};function ve(s,e,r,p,o,a){const d=S("TrainerHeader");return l(),n("div",N,[C(d,{"user-full-name":a.userFullName,onLogout:a.logout},null,8,["user-full-name","onLogout"]),o.loading?(l(),n("div",A,e[8]||(e[8]=[t("div",{class:"text-center"},[t("i",{class:"fas fa-spinner fa-spin text-4xl text-white mb-4"}),t("p",{class:"text-white text-lg"},"Nalaganje vaj testov...")],-1)]))):o.error?(l(),n("div",P,[t("div",M,[e[10]||(e[10]=t("i",{class:"fas fa-exclamation-triangle text-4xl text-red-500 mb-4"},null,-1)),e[11]||(e[11]=t("h3",{class:"text-xl font-bold text-gray-800 mb-2"},"Napaka pri nalaganju vaj testov",-1)),t("p",O,u(o.error),1),t("button",{onClick:e[0]||(e[0]=(...i)=>a.fetchTestExercises&&a.fetchTestExercises(...i)),class:"bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-200"},e[9]||(e[9]=[t("i",{class:"fas fa-redo mr-2"},null,-1),x("poskusi ponovno ")]))])])):(l(),n("div",D,[t("div",B,[t("div",L,[e[15]||(e[15]=t("div",null,[t("h1",{class:"text-3xl font-bold text-white mb-2"},[t("i",{class:"fas fa-clipboard-list mr-3"}),x("USTVARI TEST ")]),t("p",{class:"text-white/90"},"Vnesi meritve za izbrane teste. Izbrane vaje bodo zahtevane na naslednjem testu. Vnašamo Maksimalne meritve 1 ponovitve (MVC).")],-1)),t("div",R,[t("div",U,[e[12]||(e[12]=t("label",{class:"dropdown-label"},"Datum testa:",-1)),g(t("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=i=>o.testForm.test_date=i),onChange:e[2]||(e[2]=(...i)=>a.onFormChange&&a.onFormChange(...i)),class:"header-input date-input"},null,544),[[E,o.testForm.test_date]])]),t("div",G,[e[14]||(e[14]=t("label",{class:"dropdown-label"},"Izberi športnika:",-1)),g(t("select",{"onUpdate:modelValue":e[3]||(e[3]=i=>o.testForm.athlete_id=i),onChange:e[4]||(e[4]=(...i)=>a.onFormChange&&a.onFormChange(...i)),class:"header-input athlete-select"},[e[13]||(e[13]=t("option",{value:""},"Izberi športnika...",-1)),(l(!0),n(h,null,b(o.athletes,i=>(l(),n("option",{key:i.id,value:i.id},u(i.first_name)+" "+u(i.last_name),9,H))),128))],544),[[j,o.testForm.athlete_id]])])])])]),o.pastTestInfo.found_past_test?(l(),n("div",J,[t("div",q,[e[19]||(e[19]=t("i",{class:"fas fa-exclamation-circle text-orange-600 text-xl mr-3"},null,-1)),t("div",null,[e[18]||(e[18]=t("h4",{class:"font-bold text-orange-800"},"Prejšnji test je bil odkrit",-1)),t("p",K,[x(" Odkrit prejšnji test "+u(a.formatDate(o.pastTestInfo.most_recent_test_date))+" z "+u(o.pastTestInfo.exercises.length)+" vajami. ",1),e[16]||(e[16]=t("span",{class:"font-bold"},"Izpolnjene morajo biti vse vaje",-1)),e[17]||(e[17]=x(" iz preteklega testa. "))])])])])):I("",!0),t("div",Q,[e[23]||(e[23]=k('<div class="table-header grid grid-cols-12 gap-4 p-4" data-v-4aba5691><div class="col-span-6 text-left font-semibold text-white" data-v-4aba5691>VAJA</div><div class="col-span-3 text-center font-semibold text-white" data-v-4aba5691>MERITEV</div><div class="col-span-2 text-center font-semibold text-white" data-v-4aba5691>ENOTA</div><div class="col-span-1 text-center font-semibold text-white" data-v-4aba5691>PODROBNOSTI</div></div>',1)),t("div",W,[(l(!0),n(h,null,b(o.testExercises,(i,m)=>(l(),n(h,{key:"ability-"+m},[t("div",X,[t("div",Y,u(i.motor_ability),1)]),(l(!0),n(h,null,b(i.method_groups,(y,V)=>(l(),n(h,{key:"group-"+m+"-"+V},[t("div",Z,[t("div",$,u(y.method_group),1)]),(l(!0),n(h,null,b(y.exercises,c=>(l(),n("div",{key:c.id,class:T(["exercise-row grid grid-cols-12 gap-4 p-4 items-center hover:bg-white/10 transition duration-200",{"past-test-exercise":a.isPastTestExercise(c.id)}])},[t("div",ee,[t("div",te,[a.isPastTestExercise(c.id)?(l(),n("div",se,e[20]||(e[20]=[t("i",{class:"fas fa-history text-orange-500 text-sm",title:"Used in past test"},null,-1),t("span",{class:"required-indicator"},"*",-1)]))):I("",!0),t("span",ae,u(c.exercise),1)])]),t("div",ie,[g(t("input",{type:"number",step:"0.01","onUpdate:modelValue":f=>o.exerciseValues[c.id].value=f,placeholder:"Vnesi meritev",class:T(["value-input",{"past-test-input":a.isPastTestExercise(c.id)}])},null,10,oe),[[E,o.exerciseValues[c.id].value]])]),t("div",re,[g(t("select",{"onUpdate:modelValue":f=>o.exerciseValues[c.id].unit=f,class:T(["unit-select",{"past-test-input":a.isPastTestExercise(c.id)}])},e[21]||(e[21]=[k('<option value="" data-v-4aba5691>Enota</option><option value="m" data-v-4aba5691>m</option><option value="cm" data-v-4aba5691>cm</option><option value="s" data-v-4aba5691>s</option><option value="kg" data-v-4aba5691>kg</option>',5)]),10,ne),[[j,o.exerciseValues[c.id].unit]])]),t("div",le,[t("button",{onClick:f=>a.showExerciseInfo(c),class:"info-button"},e[22]||(e[22]=[t("i",{class:"fas fa-info-circle"},null,-1)]),8,de)])],2))),128))],64))),128))],64))),128))])]),t("div",ce,[t("button",{onClick:e[5]||(e[5]=(...i)=>a.saveTestResults&&a.saveTestResults(...i)),disabled:!a.isFormValid,class:"save-btn px-8 py-4 rounded-xl font-bold text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"},e[24]||(e[24]=[t("i",{class:"fas fa-save mr-2"},null,-1),x("SHRANI MERITVE TESTA ")]),8,ue),t("button",{onClick:e[6]||(e[6]=(...i)=>a.clearAllValues&&a.clearAllValues(...i)),class:"clear-btn px-8 py-4 rounded-xl font-bold text-lg transition duration-300"},e[25]||(e[25]=[t("i",{class:"fas fa-eraser mr-2"},null,-1),x("POČISTI VSE ")]))])])),o.showModal?(l(),n("div",pe,[t("div",me,[t("div",xe,[t("h1",he,u(o.selectedExercise.exercise),1),t("button",{onClick:e[7]||(e[7]=(...i)=>a.closeModal&&a.closeModal(...i)),class:"modal-close"},e[26]||(e[26]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("p",fe,u(o.selectedExercise.description),1)])])):I("",!0)])}const Ie=F(z,[["render",ve],["__scopeId","data-v-4aba5691"]]);export{Ie as default};
