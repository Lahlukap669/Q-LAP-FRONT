import{a as v}from"./api-DUlGAOJP.js";import{T as w}from"./TrainerHeader-Dx3V7vEH.js";import{_ as k,c as n,e as F,b,f as C,a as t,t as u,d as m,k as _,v as y,l as I,F as x,j as g,m as j,o as l,n as T}from"./index-Da2PU-7I.js";const z={name:"CreateTestView",components:{TrainerHeader:w},data(){return{loading:!0,error:null,testExercises:[],athletes:[],exerciseValues:{},showModal:!1,selectedExercise:{},testForm:{test_date:new Date().toISOString().split("T")[0],athlete_id:""},pastTestInfo:{found_past_test:!1,most_recent_test_id:null,most_recent_test_date:null,exercises:[]}}},computed:{userFullName(){const s=JSON.parse(localStorage.getItem("user")||"{}");return`${s.first_name} ${s.last_name}`||"Trainer"},isFormValid(){return!this.testForm.test_date||!this.testForm.athlete_id?!1:this.pastTestInfo.found_past_test?this.pastTestInfo.exercises.map(o=>o.exercise_id).every(o=>{const p=this.exerciseValues[o];return p&&p.value&&p.unit}):Object.values(this.exerciseValues).some(s=>s.value&&s.unit)}},methods:{async fetchAthletes(){var s;try{const e=await v.get("/users/trainer/my-athletes");this.athletes=e.data.athletes||[]}catch(e){console.error("Napaka pri nalaganju športnikov:",e),((s=e.response)==null?void 0:s.status)===401&&this.$router.push("/login")}},async fetchTestExercises(){var s;this.loading=!0,this.error=null;try{const e=await v.get("/users/trainer/get-test-exercises");this.testExercises=e.data.data||[],this.initializeExerciseValues()}catch(e){console.error("Error:",e),this.error="Napaka pri nalaganju vaj.",((s=e.response)==null?void 0:s.status)===401&&this.$router.push("/login")}finally{this.loading=!1}},async fetchPastTestExercises(){var s;if(!this.testForm.test_date||!this.testForm.athlete_id){this.pastTestInfo={found_past_test:!1,most_recent_test_id:null,most_recent_test_date:null,exercises:[]};return}try{const e=await v.post("/users/trainer/get-past-test-exercises",{test_date:this.testForm.test_date,athlete_id:parseInt(this.testForm.athlete_id)});this.pastTestInfo=e.data,this.pastTestInfo.found_past_test&&this.pastTestInfo.exercises&&this.pastTestInfo.exercises.forEach(o=>{this.exerciseValues[o.exercise_id]&&(this.exerciseValues[o.exercise_id].unit=o.unit)})}catch(e){console.error("Napaka pri pridobivanju preteklih vaj:",e),((s=e.response)==null?void 0:s.status)===401&&this.$router.push("/login"),this.pastTestInfo={found_past_test:!1,most_recent_test_id:null,most_recent_test_date:null,exercises:[]}}},onFormChange(){this.fetchPastTestExercises()},isPastTestExercise(s){return this.pastTestInfo.exercises.some(e=>e.exercise_id===s)},formatDate(s){return s?new Date(s).toLocaleDateString("sl-SI",{year:"numeric",month:"long",day:"numeric"}):""},initializeExerciseValues(){const s={};this.testExercises.forEach(e=>{e.method_groups.forEach(o=>{o.exercises.forEach(p=>{s[p.id]={value:"",unit:""}})})}),this.exerciseValues=s},showExerciseInfo(s){this.selectedExercise=s,this.showModal=!0},closeModal(){this.showModal=!1},clearAllValues(){this.initializeExerciseValues()},async saveTestResults(){var o,p,r;if(!this.testForm.athlete_id||!this.testForm.test_date){alert("Športnik in datum sta obvezna");return}const s=Object.entries(this.exerciseValues).filter(([i,d])=>d.value&&d.unit).map(([i,d])=>({exercise_id:parseInt(i),measure:parseFloat(d.value),unit:d.unit}));if(s.length===0){alert("Vsaj ena vaja skupaj z meritvijo in enoto je obvezna.");return}if(this.pastTestInfo.found_past_test){const d=this.pastTestInfo.exercises.map(a=>a.exercise_id).filter(a=>{const f=this.exerciseValues[a];return!f||!f.value||!f.unit});if(d.length>0){alert(`Vse vaje iz prejšnjega testa morajo biti izpolnjene. Manjkajo ${d.length} vaje/a.`);return}}const e={athlete_id:parseInt(this.testForm.athlete_id),date:this.testForm.test_date,exercises:s};this.loading=!0;try{console.log("Creating test with payload:",e);const i=await v.post("/users/trainer/create-test",e);alert(i.data.message||"Test created successfully"),this.clearAllValues(),this.testForm={test_date:new Date().toISOString().split("T")[0],athlete_id:""},setTimeout(()=>{this.$router.push("/trainer/tests")},1500)}catch(i){if(console.error("Error creating test:",i),((o=i.response)==null?void 0:o.status)===401)this.$router.push("/login");else{const d=((r=(p=i.response)==null?void 0:p.data)==null?void 0:r.message)||"Napaka pri ustvarjanju testa";alert(d)}}finally{this.loading=!1}},getMissingPastExercisesCount(){return this.pastTestInfo.found_past_test?this.pastTestInfo.exercises.map(e=>e.exercise_id).filter(e=>{const o=this.exerciseValues[e];return!o||!o.value||!o.unit}).length:0},getCompletedPastExercisesCount(){return this.pastTestInfo.found_past_test?this.pastTestInfo.exercises.map(e=>e.exercise_id).filter(e=>{const o=this.exerciseValues[e];return o&&o.value&&o.unit}).length:0},logout(){localStorage.removeItem("access_token"),localStorage.removeItem("user"),this.$router.push("/login")}},mounted(){this.fetchAthletes(),this.fetchTestExercises()}},S={class:"min-h-screen test-bg"},N={key:0,class:"flex items-center justify-center min-h-screen"},M={key:1,class:"flex items-center justify-center min-h-screen"},P={class:"text-center bg-white rounded-xl p-8 mx-4"},A={class:"text-gray-600 mb-4"},O={key:2,class:"container mx-auto px-4 py-6"},D={class:"test-header rounded-xl p-6 mb-6"},R={class:"flex items-center justify-between"},U={class:"flex items-center space-x-4"},B={class:"dropdown-container"},H={class:"dropdown-container"},L=["value"],J={key:0,class:"past-test-banner rounded-xl p-4 mb-6"},q={class:"flex items-center"},G={class:"text-orange-700 text-sm"},K={class:"exercises-table rounded-xl overflow-hidden"},Q={class:"exercise-rows"},W={class:"motor-ability-row"},X={class:"motor-ability-title"},Y={class:"method-group-row"},Z={class:"method-group-title"},$={class:"col-span-6 flex items-center"},ee={class:"flex items-center space-x-2"},te={key:0,class:"flex items-center space-x-1"},se={class:"exercise-name"},ie={class:"col-span-3 flex justify-center"},ae=["onUpdate:modelValue"],re={class:"col-span-2 flex justify-center"},oe=["onUpdate:modelValue"],ne={class:"col-span-1 flex justify-center"},le=["onClick"],de={class:"flex space-x-4 justify-center mt-6"},ce=["disabled"],ue={key:3,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"},pe={class:"modal-content max-w-2xl w-full"},fe={class:"flex justify-between items-start mb-4"},me={class:"modal-title"},xe={class:"description-text"};function he(s,e,o,p,r,i){const d=C("TrainerHeader");return l(),n("div",S,[F(d,{"user-full-name":i.userFullName,onLogout:i.logout},null,8,["user-full-name","onLogout"]),r.loading?(l(),n("div",N,e[8]||(e[8]=[t("div",{class:"text-center"},[t("i",{class:"fas fa-spinner fa-spin text-4xl text-white mb-4"}),t("p",{class:"text-white text-lg"},"Nalaganje vaj testov...")],-1)]))):r.error?(l(),n("div",M,[t("div",P,[e[10]||(e[10]=t("i",{class:"fas fa-exclamation-triangle text-4xl text-red-500 mb-4"},null,-1)),e[11]||(e[11]=t("h3",{class:"text-xl font-bold text-gray-800 mb-2"},"Napaka pri nalaganju vaj testov",-1)),t("p",A,u(r.error),1),t("button",{onClick:e[0]||(e[0]=(...a)=>i.fetchTestExercises&&i.fetchTestExercises(...a)),class:"bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-200"},e[9]||(e[9]=[t("i",{class:"fas fa-redo mr-2"},null,-1),m("poskusi ponovno ")]))])])):(l(),n("div",O,[t("div",D,[t("div",R,[e[15]||(e[15]=t("div",null,[t("h1",{class:"text-3xl font-bold text-white mb-2"},[t("i",{class:"fas fa-clipboard-list mr-3"}),m("USTVARI TEST ")]),t("p",{class:"text-white/90"},"Vnesi meritve za izbrane teste. Izbrane vaje bodo zahtevane na naslednjem testu. Vnašamo Maksimalne meritve 1 ponovitve (MVC).")],-1)),t("div",U,[t("div",B,[e[12]||(e[12]=t("label",{class:"dropdown-label"},"Datum testa:",-1)),_(t("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=a=>r.testForm.test_date=a),onChange:e[2]||(e[2]=(...a)=>i.onFormChange&&i.onFormChange(...a)),class:"header-input date-input"},null,544),[[y,r.testForm.test_date]])]),t("div",H,[e[14]||(e[14]=t("label",{class:"dropdown-label"},"Izberi športnika:",-1)),_(t("select",{"onUpdate:modelValue":e[3]||(e[3]=a=>r.testForm.athlete_id=a),onChange:e[4]||(e[4]=(...a)=>i.onFormChange&&i.onFormChange(...a)),class:"header-input athlete-select"},[e[13]||(e[13]=t("option",{value:""},"Izberi športnika...",-1)),(l(!0),n(x,null,g(r.athletes,a=>(l(),n("option",{key:a.id,value:a.id},u(a.first_name)+" "+u(a.last_name),9,L))),128))],544),[[I,r.testForm.athlete_id]])])])])]),r.pastTestInfo.found_past_test?(l(),n("div",J,[t("div",q,[e[19]||(e[19]=t("i",{class:"fas fa-exclamation-circle text-orange-600 text-xl mr-3"},null,-1)),t("div",null,[e[18]||(e[18]=t("h4",{class:"font-bold text-orange-800"},"Prejšnji test je bil odkrit",-1)),t("p",G,[m(" Odkrit prejšnji test "+u(i.formatDate(r.pastTestInfo.most_recent_test_date))+" z "+u(r.pastTestInfo.exercises.length)+" vajami. ",1),e[16]||(e[16]=t("span",{class:"font-bold"},"Izpolnjene morajo biti vse vaje",-1)),e[17]||(e[17]=m(" iz preteklega testa. "))])])])])):b("",!0),t("div",K,[e[23]||(e[23]=j('<div class="table-header grid grid-cols-12 gap-4 p-4" data-v-0f7f2413><div class="col-span-6 text-left font-semibold text-white" data-v-0f7f2413>VAJA</div><div class="col-span-3 text-center font-semibold text-white" data-v-0f7f2413>MERITEV</div><div class="col-span-2 text-center font-semibold text-white" data-v-0f7f2413>ENOTA</div><div class="col-span-1 text-center font-semibold text-white" data-v-0f7f2413>PODROBNOSTI</div></div>',1)),t("div",Q,[(l(!0),n(x,null,g(r.testExercises,(a,f)=>(l(),n(x,{key:"ability-"+f},[t("div",W,[t("div",X,u(a.motor_ability),1)]),(l(!0),n(x,null,g(a.method_groups,(E,V)=>(l(),n(x,{key:"group-"+f+"-"+V},[t("div",Y,[t("div",Z,u(E.method_group),1)]),(l(!0),n(x,null,g(E.exercises,c=>(l(),n("div",{key:c.id,class:T(["exercise-row grid grid-cols-12 gap-4 p-4 items-center hover:bg-white/10 transition duration-200",{"past-test-exercise":i.isPastTestExercise(c.id)}])},[t("div",$,[t("div",ee,[i.isPastTestExercise(c.id)?(l(),n("div",te,e[20]||(e[20]=[t("i",{class:"fas fa-history text-orange-500 text-sm",title:"Used in past test"},null,-1),t("span",{class:"required-indicator"},"*",-1)]))):b("",!0),t("span",se,u(c.exercise),1)])]),t("div",ie,[_(t("input",{type:"number",step:"0.01","onUpdate:modelValue":h=>r.exerciseValues[c.id].value=h,placeholder:"Vnesi meritev",class:T(["value-input",{"past-test-input":i.isPastTestExercise(c.id)}])},null,10,ae),[[y,r.exerciseValues[c.id].value]])]),t("div",re,[_(t("select",{"onUpdate:modelValue":h=>r.exerciseValues[c.id].unit=h,class:T(["unit-select",{"past-test-input":i.isPastTestExercise(c.id)}])},e[21]||(e[21]=[j('<option value="" data-v-0f7f2413>Enota</option><option value="m" data-v-0f7f2413>m</option><option value="cm" data-v-0f7f2413>cm</option><option value="s" data-v-0f7f2413>s</option><option value="kg" data-v-0f7f2413>kg</option>',5)]),10,oe),[[I,r.exerciseValues[c.id].unit]])]),t("div",ne,[t("button",{onClick:h=>i.showExerciseInfo(c),class:"info-button"},e[22]||(e[22]=[t("i",{class:"fas fa-info-circle"},null,-1)]),8,le)])],2))),128))],64))),128))],64))),128))])]),t("div",de,[t("button",{onClick:e[5]||(e[5]=(...a)=>i.saveTestResults&&i.saveTestResults(...a)),disabled:!i.isFormValid,class:"save-btn px-8 py-4 rounded-xl font-bold text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"},e[24]||(e[24]=[t("i",{class:"fas fa-save mr-2"},null,-1),m("SHRANI MERITVE TESTA ")]),8,ce),t("button",{onClick:e[6]||(e[6]=(...a)=>i.clearAllValues&&i.clearAllValues(...a)),class:"clear-btn px-8 py-4 rounded-xl font-bold text-lg transition duration-300"},e[25]||(e[25]=[t("i",{class:"fas fa-eraser mr-2"},null,-1),m("POČISTI VSE ")]))])])),r.showModal?(l(),n("div",ue,[t("div",pe,[t("div",fe,[t("h1",me,u(r.selectedExercise.exercise),1),t("button",{onClick:e[7]||(e[7]=(...a)=>i.closeModal&&i.closeModal(...a)),class:"modal-close"},e[26]||(e[26]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("p",xe,u(r.selectedExercise.description),1)])])):b("",!0)])}const be=k(z,[["render",he],["__scopeId","data-v-0f7f2413"]]);export{be as default};
